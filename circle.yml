#
# Build configuration for Circle CI
#

general:
    artifacts:
        - /home/ubuntu/UnClutter/app/build/outputs/apk/

machine:
    environment:
        ANDROID_HOME: /usr/local/android-sdk-linux
        GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'
        ANDROID_COMPILE_SDK: "25"
        ANDROID_BUILD_TOOLS: "26.0.2"
        ANDROID_SDK_VERSION: "25.2.5"


dependencies:
    pre:
        - wget --quiet --output-document=android-sdk.zip https://dl.google.com/android/repository/tools_r${ANDROID_SDK_VERSION}-linux.zip
        - unzip android-sdk.zip -d android-sdk-linux
        - echo y | android-sdk-linux/tools/bin/sdkmanager "platforms;android-${ANDROID_COMPILE_SDK}"
        - echo y | android-sdk-linux/tools/bin/sdkmanager "platform-tools"
        - echo y | android-sdk-linux/tools/bin/sdkmanager "build-tools;${ANDROID_BUILD_TOOLS}"
        - echo y | android-sdk-linux/tools/bin/sdkmanager "extras;android;m2repository"
        - echo y | android-sdk-linux/tools/bin/sdkmanager "extras;google;m2repository"
        - echo y | android-sdk-linux/tools/bin/sdkmanager "extras;google;google_play_services"

        #- openssl aes-256-cbc -d -in ./app/google-services.json-cipher -k $KEY >> ./app/google-services.json
        #- openssl aes-256-cbc -d -in ./app/src/gplay/google-services.json-cipher -k $KEY >> ./app/src/gplay/google-services.json
        #- openssl aes-256-cbc -d -in ./app/src/xdaedition/google-services.json-cipher -k $KEY >> ./app/src/xdaedition/google-services.json

        - bash ./circleciscripts/download_keystore.sh
    cache-directories:
        - "/usr/local/android-sdk-linux/build-tools/26.0.2"
        - "/usr/local/android-sdk-linux/extras"
        - "/usr/local/android-sdk-linux/platforms/android-26"
        - "~/repoName/.gradle"
    override:
        - chmod +x gradlew
        - ANDROID_HOME=/usr/local/android-sdk-linux ./gradlew dependencies

test:
    pre:
        #- emulator -avd circleci-android24 -no-window:
        #    background: true
        #    parallel: true
        #- circle-android wait-for-boot
    override:
        # start the build and run tests
        - (./gradlew build):
            timeout: 360
        ## run unit tests
        - ./gradlew test

        ## Run tests in emulator
        # @todo: re-add conncted tests when I fugure out how
        #- adb shell screencap -p | sed 's/\r$//' > $CIRCLE_ARTIFACTS/screen-before-unlock.png
        #- adb shell input keyevent 82
        # take a screen-shot
        #- adb shell screencap -p | sed 's/\r$//' > $CIRCLE_ARTIFACTS/screen-after-unlock.png

        # copy the build outputs to artifacts
        - cp -r app/build/outputs $CIRCLE_ARTIFACTS
        # copy the test results to the test results directory.
        - cp -r app/build/test-results $CIRCLE_TEST_REPORTS
        # copy the reports to the test results directory.
        - cp -r app/build/reports $CIRCLE_TEST_REPORTS

deployment:
    hockey:
        branch: master
        commands:
          - source ./circleciscripts/deployHockeyApp.sh && uploadToHockeyApp